#!/usr/bin/env bash
#########
# SETUP #
#########
set -euo pipefail

if [[ -v DEBUG ]]; then
	set -x
fi

# `cd` to the directory that this script is in, i.e. `devtools/bin/`
cd "$(dirname "$0")"

# `cd` back to the root of the repo
cd "../.."

REPO_ROOT="$(pwd)"


###################
# PARSE ARGUMENTS #
###################

basename="$(basename "$0")"

if [ "$#" -ge 1 ] && ( [ "$1" = "-h" ] || [ "$1" = "--help" ] ); then
	cat <<-EOF
		This script is used to foo.

		You need bar before you can use this script. Then baz, abc, and xyz.
	EOF

	# We use printf to print example commands in two columns, while making sure that the columns are aligned
	fstring="\t%-40s %s\n"
	printf "$fstring" "[EXAMPLE COMMAND]" "[DESCRIPTION]"
	printf "$fstring" "$basename" 'This invokes the default behavior, of doing abc, and then xyz.'
	#printf "$fstring" "$basename --foo" "The foo option is used to ..."
	exit 0
fi

# This is an array of all the examples that we want to build
declare -a examples

# `set -u` basically throws an exception if we try to use a variable that does
# not exist. For some reason this includes trying to compute the length of an
# empty array, even if the array has been explicitly `declare`'ed. As such, we
# need to disable `set -u` whenever we check the length of the array.
function examples_is_empty() {
	set +u
	length="${#examples[@]}"
	set -u

	# 0 is true
	return "$length"
}

# There are multiple ways to specify which example to build. In order of precidence:
# 1. CLI arguments, e.g. `./build-example arduino-micro sparkfun-promicro`
for arg in "$@"; do
	examples+=("$arg")
done

# 2. From the AVR_HAL_BUILD_TARGETS environment variable. e.g.
#
#    ```
#    export AVR_HAL_BUILD_TARGETS="arduino-micro sparkfun-promicro";
#    build-example;
#    ```
#
#    ```
#    AVR_HAL_BUILD_TARGETS="arduino-micro sparkfun-promicro" build-example;
#    ```
if examples_is_empty && [[ -v AVR_HAL_BUILD_TARGETS ]]; then
	for arg in $AVR_HAL_BUILD_TARGETS; do
		examples+=("$arg")
	done
fi

if examples_is_empty; then
	echo "Error: You must specify at least one example project to build"
	echo
	"$0" "--help"
	exit 1
fi

if [ "${#examples[@]}" -eq 1 ] && [ "${examples[0]}" = "all" ]; then
	unset examples[0]

	for arg in $(ls -d examples/*/ | cut -d '/' -f 2); do
		examples+=("$arg")
	done
fi

##############
# MAIN LOGIC #
##############

# TODO: I don't like the below `for` loop. I'd like to be able to run all the
# builds at once with a single `cargo build` command. I haven't been able to get
# it working though. The closest I've come is:
#
# ```
# cargo build --package 'path+file:///home/i/Workspaces/2/avr-hal/examples/arduino-micro#arduino-micro-examples@0.0.0' --package 'path+file:///home/i/Workspaces/2/avr-hal/examples/arduino-uno#arduino-uno-examples@0.0.0'
# ```
for example in "${examples[@]}"; do
	cd "$REPO_ROOT/examples/$example"
	echo "Building $example"
	cargo build --color=always
done
